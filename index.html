<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>SMART Observation Viewer</title>

  <!-- SMART JS -->
  <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.min.js"></script>

  <style>
    body {
      font-family: monospace;
      white-space: pre-wrap;
      padding: 1rem;
    }
    button {
      margin-top: 1rem;
      padding: 0.6rem 1.2rem;
      font-size: 1rem;
    }
  </style>
</head>

<body>
  <h2>SMART on FHIR â€“ CHARM Observation Demo</h2>

  <div id="info">Initializing...</div>

  <button id="go" disabled>Send to Shiny App</button>

  <script>
    /**********************************************************
     * ä¸‹æ¸¸ Shiny App
     **********************************************************/
    const SHINY_URL = "https://shiny-app-v2-1.onrender.com/";

    let accessToken = null;
    let fhirBase = null;
    let pid = null;
    let firstObsId = null;

    /**********************************************************
     * SMART OAuth Ready
     **********************************************************/
    FHIR.oauth2.ready()
      .then(client => {
        accessToken = client.state.tokenResponse.access_token;
        fhirBase = client.state.serverUrl;

        // â­ Sandbox é¸æ“‡çš„ç—…äºº
        pid = client.patient.id;

        if (!pid) {
          throw new Error("No patient context found (launch/patient missing)");
        }

        document.getElementById("info").textContent =
          "âœ… SMART OAuth Ready\n\n" +
          "FHIR Server:\n" + fhirBase + "\n\n" +
          "Selected Patient:\nPatient/" + pid + "\n\n" +
          "Fetching Observations...\n";

        // â­ æ­£è¦æ–¹å¼ï¼šç”¨ patient æŸ¥ Observation
        return client.request(
          `Observation?subject=Patient/${pid}&_count=10`
        );
      })
      .then(bundle => {
        if (!bundle.entry || bundle.entry.length === 0) {
          document.getElementById("info").textContent +=
            "\nâš ï¸ No Observations found for this patient.";
          return;
        }

        const observations = bundle.entry.map(e => e.resource);

        firstObsId = observations[0].id;

        document.getElementById("info").textContent +=
          "\nðŸ“„ Observations Loaded (showing up to 10):\n\n" +
          JSON.stringify(observations, null, 2) +
          "\n\nUsing Observation ID:\nObservation/" + firstObsId;

        // å•Ÿç”¨æŒ‰éˆ•
        document.getElementById("go").disabled = false;
      })
      .catch(err => {
        document.getElementById("info").textContent =
          "âŒ Error:\n" + err;
      });

    /**********************************************************
     * å‚³éžçµ¦ Shinyï¼ˆtoken + pid + obs + fhirï¼‰
     **********************************************************/
    document.getElementById("go").onclick = () => {
      if (!accessToken || !pid || !firstObsId) {
        alert("Missing data, cannot send to Shiny");
        return;
      }

      const obsUrl = `${fhirBase}/Observation/${firstObsId}`;

      const url =
        SHINY_URL +
        "#token=" + encodeURIComponent(accessToken) +
        "&pid=" + encodeURIComponent(pid) +
        "&obs=" + encodeURIComponent(obsUrl) +
        "&fhir=" + encodeURIComponent(fhirBase);

      console.log("Sent to Shiny:", {
        token: accessToken,
        pid: pid,
        fhir: fhirBase,
        obs: obsUrl
      });

      window.location.href = url;
    };
  </script>
</body>
</html>
