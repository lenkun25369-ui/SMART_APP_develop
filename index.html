<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>SMART Observation Viewer</title>

  <!-- SMART JS -->
  <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.min.js"></script>

  <style>
    body {
      font-family: monospace;
      white-space: pre-wrap;
      padding: 1rem;
    }
  </style>
</head>

<body>
  <h2>SMART on FHIR ‚Äì Observation Bundle Viewer</h2>

  <div id="info">Initializing...</div>

  <script>
    let accessToken = null;
    let fhirBase = null;
    let pid = null;

    FHIR.oauth2.ready()
      .then(client => {
        accessToken = client.state.tokenResponse.access_token;
        fhirBase = client.state.serverUrl;
        pid = client.patient.id;

        if (!pid) {
          throw new Error("No patient context (launch/patient missing)");
        }

        /* ================================
         * üîê Access TokenÔºàconsole onlyÔºâ
         * ================================ */
        console.log("üîê SMART Access Token:", accessToken);
        console.log("üîê Token length:", accessToken.length);
        console.log("üîê FHIR Server:", fhirBase);
        console.log("üîê Patient ID:", pid);
        console.log("Granted scopes:", client.state.tokenResponse.scope);

        document.getElementById("info").textContent =
          "‚úÖ SMART OAuth Ready\n\n" +
          "FHIR Server:\n" + fhirBase + "\n\n" +
          "Selected Patient:\nPatient/" + pid + "\n\n" +
          "Request:\n" +
          `GET Observation?subject=Patient/${pid}\n\n` +
          "Response:\n";

        return client.request(
          `Observation?subject=Patient/${pid}`
        );
      })
      .then(bundle => {
        document.getElementById("info").textContent +=
          JSON.stringify(bundle, null, 2);
      })
      .catch(err => {
        document.getElementById("info").textContent =
          "‚ùå Error:\n" + err;
        console.error("SMART Error:", err);
      });
  </script>
</body>
</html>
